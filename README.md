# cl_parse -- コマンドラインパーサー

## 紹介
コマンドラインのオプション、オプション引数を解析するメソッドを提供します。  
Pythonで記述するコマンドライン・プログラムに組み込んで使うものです。  
<br>

## 動作環境

 * Python 3.8以降で動きます。
   - 作成と主なテストは Python 3.8 を使用しています。
   - 3.7 でも動くと思いますが、テストしていません。
   - Enum を使っているので、3.6より古い環境では絶対に動きません。
 * Windows10/11のPowerSheel、UbuntuのBash、MacOSのBash/zsh上で動作を確認しています。

<br>

## 作成経緯

  - CLIベースのコマンドを試作／製作するとき、起動オプションの処理を手軽に記述したかった。
  - Python学習も兼ねて作成。  
  - 標準ライブラリ argparseの仕様を一部参考にした部分もありますが、もともとこのライブラリの使い方が分からなかった（私には難解だった）ので、もっと簡単なものを、と思って作っています。

<br>

## 特徴（宣伝）

   - オプション情報を配列で定義するだけなので、手軽に（ビジュアルに？）利用できます。
   - オプション引数は、解析時に指定のデータ型に変換されるので、プログラム内で容易に（改めて変換したり、型チェックをすることなく）使えます。
   - データ型の指定は、ユーザー側で定義を追加することができます。（補助関数があります）
   - 入力エラー時は、エラーメッセージ文字列とともにステータスが設定されます。その後の動作はユーザープログラム（呼び出し側のプログラム）に任されます。（argparseと最も違うところかも？）
   - エラーメッセージ文字列は、ユーザー側で再定義可能です。
   - usage:を表示したり作成したりする機能はありませんが、オプション一覧はそれなりに生成する機能があります。
   - Windows環境では、解析に先立ってワイルドカード展開、~展開をします。Unix/Linux上と似たような動きで使えます。（ブレース展開は現段階ではサポートしていません）
   - コマンドラインの指定により、オプション情報の設定内容や解析結果などを表示するデバッグ機能があります。

<br>

## **ファイル構成**

ファイル名                    | 内容
------------------------------|----
lib/cl_parse.py               | cl_parse本体（使うのに必要なのはこのファイルだけです）
lib/cl_parse_debugmodule.py   | cl_parse用デバッグモジュール
----------------------------- |--------------------------------------------------------
README.md         | このドキュメント
options.md        | コマンドラインの構成とか、言葉の定義とか
sample01.py       | 一番シンプルなサンプル
ptree.py          | miniparse使用サンプル。いわゆる treeコマンドの試作版です。
e2_path.py        | ptree.pyが呼び出している自作ライブラリ（添付用簡易版）

<br>

## **履歴**

バージョン   |日付     |変更箇所        | コメント 
------------|----------|---------------|------
0.9くらい   |2021/11/23|               |いちおう完成


<br>


# **使い方（超簡易版）**

```py
import sys
from lib import cl_parse as cl

options = [
        ["help", "-h, --help", "使い方を表示する", None],
        ["all", "-a, --all", "すべて出力"],
        ["name", "-n, --name", "使用者名を指定する//<名前>", str],
        ["count", "-c, --count", "数量を指定する//<数(整数)>", int],
        ["date", "-d, --date", "対象日//<年/月/日>", cl.strptime('%Y/%m/%d')],
]

# cl_parse 呼び出し（解析実行）
args = sys.argv
op = cl.Parse(args, options, debug=True)
```

<br>

１．パーサーの呼び出し

  - cl_parse モジュールを importします。
  - オプション情報を定義します。（上記、options）
  - 解析するコマンドライン、オプション情報で、*\<cl_parse\>.* **Parse()** を呼び出します。

<br>

---

```py
# 解析エラー時の処理は自前で行う
if op.is_error:
    print(op.get_errormessage(1), file=sys.stderr)
    print()
    print("オプション一覧", file=sys.stderr)
    cl.tabprint(op.get_optionlist(), file=sys.stderr)
    exit(1)
```

<br>

２．解析エラー時の処理

  - 解析エラー時には、 *\<option\>.* **is_error** プロパティが **True** になります。  
    その後の動作（エラーメッセージ等の表示とか、プログラムの停止とか）はユーザープログラム側に任されます。
  - 解析エラーの理由は、*\<option\>.* **get_errormessage()** メソッドで取得できます。
  - ここでオプション情報を表示したいときは、定義されたオプション情報の一覧を、*\<option\>.* **get_optionlist()** メソッドで取得することができます。
  - 上記プログラム例で、 *\<cl_parse\>.* **tabprint()** は、一覧表を表示するためのサービス関数です。
  - 通常は、ここでエラー終了します。

<br>

---

```py
# help情報の表示も自前
if op.OPT_help.isEnable:       # 使い方を表示する
    print("これは cl_parse のサンプルプログラムです。\n")
    print("オプション一覧")
    cl.tabprint(op.get_optionlist())
    exit()
```

<br>

３．helpメッセージの表示

  - helpオプション（-h、--help）の設定、helpオプションが指定された場合の helpメッセージの表示も、ユーザープログラム側で行います。
  - helpオプションが指定された時の判断方法（上記リスト中の *\<option\>.* **OPT_help.isEnable**プロパティを使用している部分）は、次項の記述を参照してください。
  - オプション情報の一覧の取得や表示は、前項の記述を参照してください。

<br>

---


```py
# 解析結果
if op.OPT_all.isEnable:        # すべて出力
    print("オプション 'all' が指定されました。")

if op.OPT_name.isEnable:       # 使用者名を指定する
    print("オプション 'name' が指定されました。")
    print(f'    {op.OPT_name.value=}')
    print()

if op.OPT_count.isEnable:       # 数量を指定する
    print("オプション 'count' が指定されました。")
    print(f'    {op.OPT_count.value=}')
    print()

if op.OPT_date.isEnable:       # 対象日
    print("オプション 'date' が指定されました。")
    print(f'    {op.OPT_date.value=}')
    print()

if len(op.params):
    print("以下のコマンド引数が入力されました。")
    print(op.params)
```


<br>

４．解析結果の取得

  - 定義したオプションが認識されると、 *\<option\>.* **OPT_\<オプション名\>** 属性が設定されます。
  - コマンドラインで該当のオプションが指定されると、*\<option\>.* **OPT_\<オプション名\>.isEnable** プロパティが **True**に設定されます。（指定されないと、初期値 = **False**のまま）
  - オプション引数が指定されると、*\<option\>.* **OPT_\<オプション名\>.value** プロパティにその値が設定されます。（オプションが指定されない場合、及びオプション引数が省略された場合は、初期値 = **None** のまま）
  - *\<option\>.* **OPT_\<オプション名\>.value** の型（type）は、オプション情報で定義されたものに対応します。  

<br>

  - コマンド引数は、*\<option\>.* **params** プロパティに文字列のリストとして格納されます。
  - パーサーの呼び出しで sys.argv を用いる場合、先頭のプログラム名もコマンド引数として格納されますので、不都合がある場合は sys.argv[1:] のように、プログラム名をとばして指定してください。


<br>
<br>
<br>
<br>


# 超簡易版のサンプルプログラムと実行例
## サンプルプログラム（sample01.pas）

```Python :sample01.py
import sys
from lib import cl_parse as cl


args = sys.argv
# 試験用コマンドライン
if len(args) <= 1:
    args = 'this.py -a ABC --name=私だ  --date 2021/10/3 # ---#'.split()

options = [
        ["help", "-h, --help", "使い方を表示する", None],
        ["all", "-a, --all", "すべて出力"],
        ["name", "-n, --name", "使用者名を指定する//<名前>", str],
        ["count", "-c, --count", "数量を指定する//<数(整数)>", int],
        ["date", "-d, --date", "対象日//<年/月/日>", cl.strptime('%Y/%m/%d')],
]

# cl_parse 呼び出し（解析実行）
op = cl.Parse(args, options, debug=True)

# 解析エラー時の処理は自前で行う
if op.is_error:
    print(op.get_errormessage(1), file=sys.stderr)
    print()
    print("オプション一覧", file=sys.stderr)
    cl.tabprint(op.get_optionlist(), file=sys.stderr)
    exit(1)

# help情報の表示も自前
if op.OPT_help.isEnable:       # 使い方を表示する
    print("これは cl_parse のサンプルプログラムです。\n")
    print("オプション一覧")
    cl.tabprint(op.get_optionlist())
    exit()

# 解析結果
if op.OPT_all.isEnable:        # すべて出力
    print("オプション 'all' が指定されました。")

if op.OPT_name.isEnable:       # 使用者名を指定する
    print("オプション 'name' が指定されました。")
    print(f'    {op.OPT_name.value=}')
    print()

if op.OPT_count.isEnable:       # 数量を指定する
    print("オプション 'count' が指定されました。")
    print(f'    {op.OPT_count.value=}')
    print()

if op.OPT_date.isEnable:       # 対象日
    print("オプション 'date' が指定されました。")
    print(f'    {op.OPT_date.value=}')
    print()

if len(op.params):
    print("以下のコマンド引数が入力されました。")
    print(op.params)

```

<br>

## **実行例**

```text
> python3 sample01.py -a --name=わたし --date=2022/2/14 -c 12 ABC XYZ
オプション 'all' が指定されました。
オプション 'name' が指定されました。
    op.OPT_name.value='わたし'

オプション 'count' が指定されました。
    op.OPT_count.value=12

オプション 'date' が指定されました。
    op.OPT_date.value=datetime.datetime(2022, 2, 14, 0, 0)

以下のコマンド引数が入力されました。
['sample01.py', 'ABC', 'XYZ']
> 
```

<br>
<br>
<br>
<br>

# もう少し詳しい説明
## オプション情報

下記のように４項目からなるリストを１オプション分の定義情報とし、オプション数分のリストで１組のオプション情報とする。
```
option = [
    [＜第１項目＞, ＜第２項目＞, ＜第３項目＞, ＜第４項目＞], 
    ..... ,
    ..... ,
]
```

項目          | 型                   | 内容
--------------|----------------------|------------------------------------------------
第１項目      | str（文字列）        | オプション名
第２項目      | str（文字列）        | オプション文字列（複数の場合は , で区切る）
第３項目      | str（文字列）        | オプションのコメント
第４項目      | いろいろ             | オプション、オプション引数の「振る舞い」の定義

<br>

---
### **１．オプション名**
  - "help"、"all"、"date" など、オプションの「名前」を文字列で定義します。
  - 文字列は、Pythonの変数名に使用できる文字のみが使用できます。
  - オプション名は、プログラム内でオプションの識別のために使用されます。

<br>

### **２．オプション文字列**
  - ”-h, --help"、"-d, --date" など、実際にコマンド文字列で入力する文字列を定義します。
  - 一つのオプションに対し、複数のオプション文字列をカンマ（,）で区切って定義することができます。
  - 同一のオプションに、１文字オプション文字列、ロング名オプション文字列を両方定義したり、片方のみを定義することもできます。
  - １文字オプション文字列は、ハイフン（-）に続く英数字１文字の文字列で定義します。本モジュールでは英数字以外に 「-?」 も許容します。  
   　ex)　-a、-b、-9、 -?　など
  - ロング名オプション文字列は、２つのハイフン（--）に続く英数字、ハイフン（-）で構成される文字列で定義します。本モジュールでは、アンダーバー（_）も許容します。ただし、文字列の最後のハイフン（-）は許容しません。  
   　ex)　--version、--display-size、--audio_contorol　など

<br>

### **３．オプションのコメント**
  - オプションのコメントを定義します。
  - オプション引数のコメントを併記するときは、２つのスラッシュ（//）で区切って定義します。
  - このコメントは、オプション一覧、ユーティリティ機能でテンプレートを出力したときのコメントで使用されます。コマンドライン解析自体には（あっても無くても）影響しません。
  - オプションのコメントが不要な時は、空文字列（""）を指定してください。

<br>

### **４．オプション、オプション引数の「振る舞い」の定義**
  - ここには、アクション（オプションが指定された時の振る舞い）を指定する文字列や、呼び出し可能オブジェクト（オプション引数の変換用関数）を記述します。列挙型クラスを記述することもできます。
  - 複数の指定を記述するときは、タプル、またはリストにします。単独の指定のときはタプル、またはリストにしても、そのまま記述してもかまいません。
  - オプション引数を持たず、ただ「指定されたかどうか」だけを判断するオプションは、**None** を指定するか、この項目自体を省略します。

<br>

  - アクションを指定する文字列は、以下のものがあります。

アクション文字列 | アクション内容                  | 他のアクションと併用|変換用関数、または列挙型との併用
-----------------|---------------------------------|---------------------|----------------------
指定なし         | オプション引数の値を格納        | --                  |必要
"OPTIONAL"       | オプション引数を省略可能        | APPEND と併用可     |可、省略時は strと同じ
"APPEND"         | オプション引数の値をリストに格納| OPTIONAL と併用可   |可、省略時は strと同じ
"COUNT"          | オプション指定の回数を取得      | 不可                |不可

<br>
<br>

  - 変換用関数として、以下のような組み込み関数が使えます。

組み込み関数   | 機能
---------------|---------------------------------------------------
str            | オプション引数をそのまま格納（変換はしません）
int            | 整数に変換して格納
float          | 浮動小数点数に変換して格納


<br>

  - cl_parse で定義している変換用関数は、以下のものがあります。

cl_parse で定義している関数   |  機能
------------------------------|-------------------------------------------------------------------
\<cl_parse\>.int_literal      | 整数リテラル（"0x04FF" とか）を整数に変換
\<cl_parse\>.date             | <年>/<月>/<日> の形式の文字列を datetime型に変換して格納
\<cl_parse\>.strptime(format) |  指定したformatで、文字列を datetime型に変換して格納
\<cl_parse\>.str_choices(文字列リスト)   | 文字列リストにある文字列であれば格納、無ければエラー
\<cl_parse\>.sepalate_items(変換関数, セパレータ, item数) | 文字列を指定のセパレータで分割、各項目を指定の変換関数で変換してリストに格納

<br>

  - 列挙型クラスとして、以下のものを指定可能です。

列挙型クラス        | 機能
--------------------|----------------------------------------------------------------------------
Enum型、IntEnum型   | 属性値に相当する文字列を、指定の型の属性値に変換して格納
Flag型、IntFlag型   | 属性値に相当する文字列を、指定の型の属性値に変換して格納。オプション引数文字列に、or演算子（\|）を使うことができます

<br>
<br>

  - 変換用関数は、以下の条件を満たしている必要があります。
      * オプション引数（文字列）を入力(関数の引数）とする。
      * 解釈結果を出力とする。
      * 解釈エラー（変換エラー）時は、適切な例外を raiseする。
  - 上記の条件を満たす関数であれば、ユーザー側で作成したものも使用することができます。  
    本モジュールでは、ユーザーが変換用関数を作成するための補助関数も用意しています。（説明は別途）

<br>

  - 「振る舞い」の定義の例
     * **None**、または省略
       - オプション引数なし、オプションが指定されたかどうかだけを取得する。
       - オプションが指定された場合は、*\<option\>.* **OPT_\<オプション名\>.isEnable** がTrueに設定される。
       - *\<option\>.* **OPT_\<オプション名\>.value** は初期値=None のまま変わらない。  
     * "COUNT"
       - オプションが指定された回数のみを取得する。
       - オプションが指定された場合は、*\<option\>.* **OPT_\<オプション名\>.isEnable** がTrueに設定される。
       - *\<option\>.* **OPT_\<オプション名\>.value** に指定された回数が入る。  
     * str
       - オプション引数をそのまま（文字列のまま）格納する。
       - オプションが指定された場合は、*\<option\>.* **OPT_\<オプション名\>.isEnable** がTrueに設定される。
       - *\<option\>.* **OPT_\<オプション名\>.value** に指定されたオプション引数が入る。  
     * int
       - オプション引数を整数に変換して格納する。
       - オプションが指定された場合は、*\<option\>.* **OPT_\<オプション名\>.isEnable** がTrueに設定される。
       - *\<option\>.* **OPT_\<オプション名\>.value** に変換された整数が入る。変換できないときは入力エラーになる。  
     * ("OPTIONAL", int, float )
       - オプション引数を整数、または浮動小数点数に変換して格納する。整数に変換できないときは浮動小数点数に変換し、どちらにも変換できないときは入力エラーになる。
       - オプションが指定された場合は、*\<option\>.* **OPT_\<オプション名\>.isEnable** がTrueに設定される。
       - *\<option\>.* **OPT_\<オプション名\>.value** に変換された整数（int型）、または浮動小数点数（float型）が入る。変換できないときは入力エラーになる。  
       - オプション引数省略時は、*\<option\>.* **OPT_\<オプション名\>.value** に None （初期値と同じ値）が入る。








